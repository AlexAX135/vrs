name: Build V3 Release

on:
  push:
    branches: master
      tags:   v3.*
  pull_request:
    branches: master
      tags:   v3.*

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2

      - name:  Extract tag
        id:    get_tag
        run:   echo ::set-output name=VRS_TAG::${GITHUB_REF/refs\/tags\//}
        shell: bash

      - name:  Extract version number from tag (i.e. strip leading V from tag)
        id:    get_version
        run:   echo ::set-output name=VRS_VERSION::${VRS_TAG/v}
        shell: bash

      - name: Setup Nuget
        uses: NuGet/setup-nuget@v1.0.2
        with:
          nuget-version: '5.x'

      - name: Restore packages
        run:  nuget restore VirtualRadar.sln

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.0.2
        with:
          vs-version: '[16.0.0.0,16.65535.65535.65535]'

      - name: Build x86 release
        run:  msbuild VirtualRadar.sln -property:Configuration=Release,Platform=x86 -nowarn:1570,1572,1573,1574,1584,1587,1591,1711

      - name: Build x64 release
        run:  msbuild VirtualRadar.sln -property:Configuration=Release,Platform=x64 -nowarn:1570,1572,1573,1574,1584,1587,1591,1711

      - name: Build x86 installer
        run:  iscc /Q "/DVersion=$VRS_VERSION" Installers\InnoSetup\VirtualRadar-x86.iss

      - name: Create Github release
        id:   create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: $VRS_TAG
          release_name: $VRS_TAG
          draft: true
          prerelease: true

      - name: Add x86 installer to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: Installers\InnoSetup\Output\VirtualRadar-x86-$VRS_VERSION.exe
          asset_name:                             VirtualRadar-x86-$VRS_VERSION.exe
          asset_content_type: application/vnd.microsoft.portable-executable
